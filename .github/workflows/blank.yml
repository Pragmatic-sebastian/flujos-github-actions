name: Actualizar Localizaciones Pragmatic

on:
  workflow_dispatch:  # Solo ejecución manual

jobs:
  update-submodules:
    runs-on: ubuntu-latest

    env:
      # Submódulos a actualizar
      SUBMODULES: "l10n_co_base l10n_co_cei l10n_co_payroll"

      # Rama de destino ya definida (AJÚSTALA AQUÍ)
      TARGET_BRANCH: "18.0"

    steps:

    # 1. Clonar el repositorio externo del cliente
    - name: Checkout external repo (cliente)
      uses: actions/checkout@v4
      with:
        repository: Pragmatic-sebastian/trial-github-actions
        ref: master
        token: ${{ secrets.TOKEN_ODOO_SH }}
        submodules: false

    # 2. Inicializar submódulos
    - name: Inicializar submódulos
      run: git submodule update --init --recursive

    # 3. Actualizar solo los submódulos requeridos
    - name: Actualizar submódulos requeridos
      run: |
        echo "==> Submódulos a actualizar: $SUBMODULES"
        echo "==> Rama destino: $TARGET_BRANCH"

        for module in $SUBMODULES; do
          if [ -d "$module" ]; then
            echo "----> Actualizando $module ..."
            cd "$module"

            git fetch origin

            # Cambiar a la rama fija
            git checkout "$TARGET_BRANCH"
            git pull origin "$TARGET_BRANCH"

            cd -
          else
            echo "⚠️  El submódulo $module NO existe. Omitiendo."
          fi
        done

    # 4. Commit de cambios
    - name: Commit de cambios
      run: |
        git add .
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git commit -m "Actualización automática de submódulos: $SUBMODULES (rama $TARGET_BRANCH)" \
          || echo "No hay cambios para commitear"

    # 5. Push al repositorio externo
    - name: Push de cambios
      run: |
        git push origin HEAD:${{ github.ref_name }} --recurse-submodules=on-demand
